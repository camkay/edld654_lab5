<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Key" />


<title>Lab 5</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/journal.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<script src="highlight-custom.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="website-custom.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 61px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h2 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h3 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h4 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h5 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h6 {
  padding-top: 66px;
  margin-top: -66px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EDLD 654</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="schedule.html">Slides, Readings, &amp; Schedule</a>
</li>
<li>
  <a href="assignments.html">Assignments</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="site-syllabus.html">Syllabus</a>
</li>
<li>
  <a href="https://www.kaggle.com/c/edld-654-fall-2020/overview">Kaggle</a>
</li>
<li>
  <a href="talapas-pkg-install.html">
    <span class="fa fa-server"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/uo-datasci-specialization/c4-ml-fall-2020">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Lab 5</h1>
<h3 class="subtitle">Random Forests/Bagging</h3>
<h4 class="author">Key</h4>
<h4 class="date">Assigned 11/18/20, Due 11/25/20</h4>

</div>


<div id="data" class="section level2">
<h2>Data</h2>
<p>Read in the <code>train.csv</code> data.</p>
<ul>
<li>Because some of the models will take some time run, randomly sample 1% of the data (be sure to use <code>set.seed</code>).</li>
<li>Remove the <em>classification</em> variable.</li>
</ul>
<p>Read in the <code>fallmembershipreport_20192020.xlsx</code> data.</p>
<ul>
<li>Select <code>Attending School ID</code>, <code>School Name</code>, and all columns that represent the race/ethnicity percentages for the schools (there is example code in recent class slides).</li>
</ul>
<p>Join the two data sets.</p>
<p>If you have accessed outside data to help increase the performance of your models for the final project (e.g., <a href="https://nces.ed.gov/">NCES</a>), you can read in and join those data as well.</p>
</div>
<div id="split-and-resample" class="section level2">
<h2>Split and Resample</h2>
<p>Split joined data from above into a training set and test set, stratified by the outcome <code>score</code>.</p>
<p>Use 10-fold CV to resample the training set, stratified by <code>score</code>.</p>
</div>
<div id="preprocess" class="section level2">
<h2>Preprocess</h2>
<p>Create one <code>recipe</code> to prepare your data for CART, bagged tree, and random forest models.</p>
<p>This lab could potentially serve as a template for your <strong>Premilinary Fit 2</strong>, or your final model prediction for the <strong>Final Project</strong>, so consider applying what might be your best model formula and the necessary preprocessing steps.</p>
</div>
<div id="decision-tree" class="section level2">
<h2>Decision Tree</h2>
<ol style="list-style-type: decimal">
<li><p>Create a <code>parsnip</code> CART model using<code>{rpart}</code> for the estimation, tuning the cost complexity and minimum <span class="math inline">\(n\)</span> for a terminal node.</p></li>
<li><p>Create a <code>workflow</code> object that combines your <code>recipe</code> and your <code>parsnip</code> objects.</p></li>
<li><p>Tune your model with <code>tune_grid</code></p></li>
</ol>
<ul>
<li>Use <code>grid = 10</code> to choose 10 grid points automatically</li>
<li>In the <code>metrics</code> argument, please include <code>rmse</code>, <code>rsq</code>, and <code>huber_loss</code></li>
<li>Record the time it takes to run. You could use <code>{tictoc}</code>, or you could do something like:</li>
</ul>
<pre class="r"><code>start_rf &lt;- Sys.time()
#code to fit model
end_rf &lt;- Sys.time()
end_rf - start_rf</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Show the best estimates for each of the three performance metrics and the tuning parameter values associated with each.</li>
</ol>
</div>
<div id="bagged-tree" class="section level2">
<h2>Bagged Tree</h2>
<ol style="list-style-type: decimal">
<li>Create a <code>parsnip</code> bagged tree model using<code>{baguette}</code></li>
</ol>
<ul>
<li>specify 10 bootstrap resamples (only to keep run-time down), and</li>
<li>tune on <code>cost_complexity</code> and <code>min_n</code></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><p>Create a <code>workflow</code> object that combines your <code>recipe</code> and your bagged tree model specification.</p></li>
<li><p>Tune your model with <code>tune_grid</code></p></li>
</ol>
<ul>
<li>Use <code>grid = 10</code> to choose 10 grid points automatically</li>
<li>In the <code>metrics</code> argument, please include <code>rmse</code>, <code>rsq</code>, and <code>huber_loss</code></li>
<li>In the <code>control</code> argument, please include <code>extract = function(x) extract_model(x)</code> to extract the model from each fit</li>
<li><code>{baguette}</code> is optimized to run in parallel with the <code>{future}</code> package. Consider using <code>{future}</code> to speed up processing time (see the class slides)</li>
<li>Record the time it takes to run</li>
</ul>
<div id="question-before-you-run-the-code-how-many-trees-will-this-function-execute" class="section level4">
<h4><strong>Question: Before you run the code, how many trees will this function execute?</strong></h4>
<ol start="4" style="list-style-type: decimal">
<li><p>Show the single best estimates for each of the three performance metrics and the tuning parameter values associated with each.</p></li>
<li><p>Run the <code>bag_roots</code> function below. Apply this function to the extracted bagged tree models from the previous step. This will output the feature at the root node for each of the decision trees fit.</p></li>
</ol>
<pre class="r"><code>bag_roots &lt;- function(x){
  x %&gt;% 
  select(.extracts) %&gt;% 
  unnest(cols = c(.extracts)) %&gt;% 
  mutate(models = map(.extracts,
                  ~.x$model_df)) %&gt;% 
  select(-.extracts) %&gt;% 
  unnest(cols = c(models)) %&gt;% 
  mutate(root = map_chr(model,
                     ~as.character(.x$fit$frame[1, 1]))) %&gt;%
  select(root)  
}</code></pre>
<ol start="6" style="list-style-type: decimal">
<li>Produce a plot of the frequency of features at the root node of the trees in your bagged model.</li>
</ol>
</div>
</div>
<div id="random-forest" class="section level2">
<h2>Random Forest</h2>
<ol style="list-style-type: decimal">
<li>Create a <code>parsnip</code> random forest model using <code>{ranger}</code></li>
</ol>
<ul>
<li>use the <code>importance = "permutation"</code> argument to run variable importance</li>
<li>specify 1,000 trees, but keep the other default tuning parameters</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><p>Create a <code>workflow</code> object that combines your <code>recipe</code> and your random forest model specification.</p></li>
<li><p>Fit your model</p></li>
</ol>
<ul>
<li>In the <code>metrics</code> argument, please include <code>rmse</code>, <code>rsq</code>, and <code>huber_loss</code></li>
<li>In the <code>control</code> argument, please include <code>extract = function(x) x</code> to extract the workflow from each fit</li>
<li>Record the time it takes to run</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><p>Show the single best estimates for each of the three performance metrics.</p></li>
<li><p>Run the two functions in the code chunk below. Then apply the <code>rf_roots</code> function to the results of your random forest model to output the feature at the root node for each of the decision trees fit in your random forest model.</p></li>
</ol>
<pre class="r"><code>rf_tree_roots &lt;- function(x){
  map_chr(1:1000, 
           ~ranger::treeInfo(x, tree = .)[1, &quot;splitvarName&quot;])
}

rf_roots &lt;- function(x){
  x %&gt;% 
  select(.extracts) %&gt;% 
  unnest(cols = c(.extracts)) %&gt;% 
  mutate(fit = map(.extracts,
                   ~.x$fit$fit$fit),
         oob_rmse = map_dbl(fit,
                         ~sqrt(.x$prediction.error)),
         roots = map(fit, 
                        ~rf_tree_roots(.))
         ) %&gt;% 
  select(roots) %&gt;% 
  unnest(cols = c(roots))
}</code></pre>
<ol start="6" style="list-style-type: decimal">
<li><p>Produce a plot of the frequency of features at the root node of the trees in your bagged model.</p></li>
<li><p>Please explain why the bagged tree root node figure and the random forest root node figure are different.</p></li>
<li><p>Apply the <code>fit</code> function to your random forest <code>workflow</code> object and your <strong>full</strong> training data. In class we talked about the idea that bagged tree and random forest models use resampling, and one <em>could</em> use the OOB prediction error provided by the models to estimate model performance.</p></li>
</ol>
<ul>
<li>Record the time it takes to run</li>
<li>Extract the oob prediction error from your fitted object. If you print your fitted object, you will see a value for <em>OOB prediction error (MSE)</em>. You can take the <code>sqrt()</code> of this value to get the <em>rmse</em>. Or you can extract it by running: <code>sqrt(fit-object-name-here$fit$fit$fit$prediction.error)</code>.</li>
<li>How does OOB <em>rmse</em> here compare to the mean <em>rmse</em> estimate from your 10-fold CV random forest? How might 10-fold CV influence bias-variance?</li>
</ul>
</div>
<div id="compare-performance" class="section level2">
<h2>Compare Performance</h2>
<p>Consider the four models you fit: (a) decision tree, (b) bagged tree, (c) random forest fit on resamples, and (d) random forest fit on the training data. Which model would you use for your final fit? Please consider the performance metrics as well as the run time, and briefly explain your decision.</p>
</div>

<p>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
<img alt="Creative Commons License" style="border-width:0" src="by-nc.png" width="65"/></a>
<link rel="stylesheet" href="website-custom.css" type="text/css" />
</p>
<script src="highlight-custom.js"></script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
